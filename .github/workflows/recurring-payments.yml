name: Recurring Payments Processor

on:
  # RuleazƒÉ zilnic la 9:00 AM UTC (12:00 PM Romania)
  schedule:
    - cron: '0 9 * * *'
  
  # Permite rularea manualƒÉ din GitHub interface
  workflow_dispatch:

jobs:
  process-recurring-payments:
    runs-on: ubuntu-latest
    
    steps:
      - name: Process Recurring Payments
        run: |
          echo "üîÑ Processing recurring payments..."
          echo "üìç Environment: Production"
          echo "üåê Target URL: ${{ secrets.APP_URL }}/api/cron/recurring-payments"
          echo "üîê Using secret: ${CRON_SECRET:0:20}..." # Show first 20 chars only
          
          # Make request to recurring payments cron endpoint
          response=$(curl -L -s -w "HTTPSTATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_RECURRING_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/cron/recurring-payments")
          
          # Extract body and status code
          body=$(echo "$response" | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')
          status=$(echo "$response" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
          
          echo "üìä Status Code: $status"
          echo "üìù Response Body: $body"
          
          # Check if request was successful
          if [ "$status" -eq 200 ]; then
            echo "‚úÖ API call successful"
            
            # Parse JSON response for details
            if echo "$body" | jq empty 2>/dev/null; then
              echo "üìä Results Summary:"
              echo "$body" | jq -r '.results | "  ‚Ä¢ Processed: \(.processed) subscriptions"'
              echo "$body" | jq -r '.results | "  ‚Ä¢ Successful: \(.successful) renewals"' 
              echo "$body" | jq -r '.results | "  ‚Ä¢ Failed: \(.failed) renewals"'
              
              # Show errors if any
              echo "$body" | jq -r '.results.errors[]? | "‚ùå Error: \(.)"'
              
              # Check if any payments failed
              failed_count=$(echo "$body" | jq -r '.results.failed // 0')
              if [ "$failed_count" -gt 0 ]; then
                echo "‚ö†Ô∏è  WARNING: $failed_count payment(s) failed!"
                echo "üìã Check production logs for detailed error information"
                # Don't exit 1 here - failed payments are handled, not workflow failures
              fi
              
              echo "‚úÖ Recurring payments workflow completed successfully"
            else
              echo "‚ùå Invalid JSON response from API"
              echo "Raw response: $body"
              exit 1
            fi
          else
            echo "‚ùå Failed to process recurring payments"
            echo "HTTP Status: $status"
            echo "Response: $body"
            exit 1
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_RECURRING_SECRET }}

      - name: Check Subscriptions Status (Optional)
        if: success()
        run: |
          echo "üìä Checking upcoming renewals..."
          
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.APP_URL }}/api/admin/recurring-payments")
          
          body=$(echo "$response" | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')
          status=$(echo "$response" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
          
          if [ "$status" -eq 200 ]; then
            echo "$body" | jq -r '"ÔøΩÔøΩ Upcoming renewals: \(.count) subscriptions need attention in the next 24 hours"'
          fi